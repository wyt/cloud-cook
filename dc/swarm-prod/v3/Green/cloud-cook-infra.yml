version: '3'
services:
  # 集群每增加一个eureka节点，需要对应修改startup.sh中的CLUSTERS_EUREKA_SERVER_URLS值
  # eureka有多个时
  #   CLUSTERS_EUREKA_SERVER_MODE值应为true
  #   CLUSTERS_EUREKA_SERVER_INSTANCE_HOSTNAME应该与serviceID一致
  eureka-server:
    image: wangyt/eureka-server:${INFRA_IMAGE_VER}
    deploy:
      placement:
        constraints: [node.labels.name == dlink-ops-03-backend-204]
    environment:
      - FILEBEAT_OP_LS_HOSTS=${FILEBEAT_OP_LS_HOSTS}
      - CLUSTERS_EUREKA_SERVER_MODE=true
      - CLUSTERS_EUREKA_SERVER_PORT=7777
      - CLUSTERS_EUREKA_SERVER_INSTANCE_HOSTNAME=eureka-server
      - CLUSTERS_EUREKA_SERVER_URLS=${CLUSTERS_EUREKA_SERVER_URLS}
    entrypoint:
      - ./filebeat-springboot-entrypoint.sh
      - /eureka-server.jar
      - --spring.profiles.active=${SPRING_PROFILES_ACTIVE}
    ports:
      - 7777:7777

  eureka-server-2:
    image: wangyt/eureka-server:${INFRA_IMAGE_VER}
    deploy:
      placement:
        constraints: [node.labels.name == dlink-ops-06-backend-205]
    environment:
      - FILEBEAT_OP_LS_HOSTS=${FILEBEAT_OP_LS_HOSTS}
      - CLUSTERS_EUREKA_SERVER_MODE=true
      - CLUSTERS_EUREKA_SERVER_PORT=7777
      - CLUSTERS_EUREKA_SERVER_INSTANCE_HOSTNAME=eureka-server-2
      - CLUSTERS_EUREKA_SERVER_URLS=${CLUSTERS_EUREKA_SERVER_URLS}
    entrypoint:
      - ./filebeat-springboot-entrypoint.sh
      - /eureka-server.jar
      - --spring.profiles.active=${SPRING_PROFILES_ACTIVE}
    ports:
      - 7777:7777

  config-server:
    image: wangyt/config-server:${INFRA_IMAGE_VER}
    deploy:
      placement:
        constraints: [node.labels.name == dlink-ops-03-backend-204]
    depends_on:
      - eureka-server
    environment:
      - FILEBEAT_OP_LS_HOSTS=${FILEBEAT_OP_LS_HOSTS}
      - CLUSTERS_EUREKA_SERVER_URLS=${CLUSTERS_EUREKA_SERVER_URLS}
    entrypoint:
      - ./wait-for-it.sh
      - eureka-server:7777
      - --timeout=0
      - --strict
      - --
      - /filebeat-springboot-entrypoint.sh
      - /config-server.jar
      - --spring.profiles.active=native
    ports:
      - 7766:7766
  gateway-service:
    image: wangyt/gateway-service:${INFRA_IMAGE_VER}
    deploy:
      mode: replicated
      replicas: 2
      placement:
        constraints:
          - node.labels.region == Blue
    depends_on:
      - eureka-server
      - config-server
    environment:
      - FILEBEAT_OP_LS_HOSTS=${FILEBEAT_OP_LS_HOSTS}
      - CLUSTERS_EUREKA_SERVER_URLS=${CLUSTERS_EUREKA_SERVER_URLS}
    entrypoint:
      - ./wait-for-it.sh
      - config-server:7766
      - --timeout=0
      - --strict
      - --
      - /filebeat-springboot-entrypoint.sh
      - /gateway-service.jar
      - --spring.profiles.active=${SPRING_PROFILES_ACTIVE}
    ports:
      - 7000:7000
  turbine-service:
    image: wangyt/turbine-service:${INFRA_IMAGE_VER}
    deploy:
      placement:
        constraints: [node.labels.name == dlink-ops-03-backend-204]
    depends_on:
      - eureka-server
      - config-server
    environment:
      - FILEBEAT_OP_LS_HOSTS=${FILEBEAT_OP_LS_HOSTS}
      - CLUSTERS_EUREKA_SERVER_URLS=${CLUSTERS_EUREKA_SERVER_URLS}
    entrypoint:
      - ./wait-for-it.sh
      - config-server:7766
      - --timeout=0
      - --strict
      - --
      - /filebeat-springboot-entrypoint.sh
      - /turbine-service.jar
      - --spring.profiles.active=${SPRING_PROFILES_ACTIVE}
    ports:
      - 7788:7788
  zipkin-service:
    image: wangyt/zipkin-service:${INFRA_IMAGE_VER}
    deploy:
      placement:
        constraints: [node.labels.name == dlink-ops-03-backend-204]
    depends_on:
      - eureka-server
      - config-server
    environment:
      - FILEBEAT_OP_LS_HOSTS=${FILEBEAT_OP_LS_HOSTS}
      - CLUSTERS_EUREKA_SERVER_URLS=${CLUSTERS_EUREKA_SERVER_URLS}
    entrypoint:
      - ./wait-for-it.sh
      - config-server:7766
      - --timeout=0
      - --strict
      - --
      - /filebeat-springboot-entrypoint.sh
      - /zipkin-service.jar
      - --spring.profiles.active=${SPRING_PROFILES_ACTIVE}
    ports:
      - 7755:7755
networks:
  default:
    external:
      name: cloud-cook-overlay